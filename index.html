const ASSETS = {
        player: "sprites/Bella16bit.gif",
        heart: "sprites/Heart.png",
        bomb: "sprites/Bomb.png",
        clouds: ["sprites/cloud1.png", "sprites/cloud2.png", "sprites/cloud3.png"],
        items: ["sprites/BlueFlower.png", "sprites/CatWhite.png", "sprites/Dog.png", "sprites/Dumpling.png", "sprites/Flower1.png", "sprites/Mango.png", "sprites/Racoon.png"]
    };

    let playerX = window.innerWidth / 2 - 45, targetX = playerX;
    let score=0, health=3, combo=0, isFever=false, isImmune=false, isGameOver=false;
    let fallingItems=[], clouds=[];
    let speedFall=4, spawnInterval, feverTimer=null, immunityTimer=null;

    const playerEl = document.getElementById("player");
    const gameContainer = document.getElementById("game");
    const feverBanner = document.getElementById("feverBanner");
    playerEl.style.backgroundImage = `url(${ASSETS.player})`;

    const snd = {
        pickup: document.getElementById("pickupSound"),
        hurt: document.getElementById("hurtSound"),
        start: document.getElementById("startChime"),
        btn: document.getElementById("buttonSound"),
        game: document.getElementById("gameMusic"),
        note: document.getElementById("noteMusic")
    };

    function playSfx(audio) {
        if(!audio) return;
        audio.pause();
        audio.currentTime = 0;
        audio.play().catch(e => {});
    }

    function toggleFullscreen() {
        let doc = document.documentElement;
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
            let rfs = doc.requestFullscreen || doc.webkitRequestFullscreen || doc.mozRequestFullScreen || doc.msRequestFullscreen;
            if(rfs) rfs.call(doc).catch(e => {});
        } else {
            let efs = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
            if(efs) efs.call(document);
        }
    }

    function slideTo(id) {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      const target = document.getElementById(id);
      if(target) target.classList.add("active");
    }

    function goNote(){ 
        playSfx(snd.btn);
        if(snd.note) snd.note.play().catch(()=>{}); 
        slideTo("notePage"); 
    }
    
    function startGame(){ 
        playSfx(snd.start);
        if(snd.note) snd.note.pause();
        if(snd.game) {
            snd.game.currentTime = 0;
            snd.game.play().catch(()=>{});
        }
        
        // Attempt fullscreen but don't let it crash the start logic
        try { toggleFullscreen(); } catch(e) {}
        
        slideTo("gamePage"); 
        initGame(); 
    }
    
    function retryGame(){ 
        playSfx(snd.btn);
        if(snd.game) {
            snd.game.currentTime = 0;
            snd.game.play().catch(()=>{});
        }
        slideTo("gamePage"); 
        initGame(); 
    }

    function initGame(){
      score=0; health=3; combo=0; isGameOver=false; speedFall=4; isImmune=false;
      if(immunityTimer) clearTimeout(immunityTimer);
      stopFever();
      playerEl.classList.remove("flash");
      document.getElementById("scoreDisp").textContent=0;
      updateHealthUI();
      fallingItems.forEach(i=>i.el.remove());
      fallingItems=[];
      clearInterval(spawnInterval);
      spawnInterval = setInterval(spawnItem, 800);
    }

    function updateHealthUI(){
      const hDisp = document.getElementById("healthDisp");
      if(!hDisp) return;
      hDisp.innerHTML="";
      for(let i=0; i<health; i++){
        const img=document.createElement("img");
        img.src=ASSETS.heart;
        hDisp.appendChild(img);
      }
    }

    function triggerDamage() {
        if(isImmune || isGameOver) return;
        health--;
        updateHealthUI();
        playSfx(snd.hurt);
        gameContainer.classList.add("shake");
        setTimeout(() => gameContainer.classList.remove("shake"), 300);
        if(health <= 0) {
            gameOver();
        } else {
            isImmune = true;
            playerEl.classList.add("flash");
            if(immunityTimer) clearTimeout(immunityTimer);
            immunityTimer = setTimeout(() => { 
                isImmune = false; 
                playerEl.classList.remove("flash"); 
            }, 1500);
        }
    }

    function startFever() {
        if(isFever) return;
        isFever = true;
        gameContainer.classList.add("fever-active");
        feverBanner.style.display = "block";
        if(feverTimer) clearTimeout(feverTimer);
        feverTimer = setTimeout(() => stopFever(), 10000);
    }

    function stopFever() {
        isFever = false;
        combo = 0;
        gameContainer.classList.remove("fever-active");
        feverBanner.style.display = "none";
    }

    function spawnItem(){
      if(isGameOver) return;
      const item=document.createElement("div");
      item.classList.add("falling");
      const rng = Math.random();
      let type = "normal";
      let img = ASSETS.items[Math.floor(Math.random()*ASSETS.items.length)];
      if(rng < 0.15) { type = "bomb"; img = ASSETS.bomb; }
      else if(rng < 0.22 && health < 3) { type = "heart"; img = ASSETS.heart; }
      item.style.backgroundImage = `url(${img})`;
      const x = Math.random()*(window.innerWidth-60);
      item.style.left = x + "px";
      item.style.top = "-70px";
      gameContainer.appendChild(item);
      fallingItems.push({el:item, y:-70, x: x, type: type});
    }

    // Improved touch handling for mobile
    window.addEventListener("touchmove", e => { 
        if(e.touches.length > 0) targetX = e.touches[0].clientX - 45;
    }, {passive: true});
    window.addEventListener("mousemove", e => targetX = e.clientX - 45);

    function update() {
      if(!isGameOver && document.getElementById("gamePage").classList.contains("active")){
        let dx = targetX - playerX;
        playerX += dx * 0.15;
        playerEl.style.left = playerX + "px";
        if(Math.abs(dx) > 1) playerEl.style.transform = dx > 0 ? "scaleX(1)" : "scaleX(-1)";

        for(let i=fallingItems.length-1; i>=0; i--){
          let item = fallingItems[i];
          if(isFever && item.type !== "bomb") {
              let dist = (playerX + 45) - (item.x + 30);
              if(Math.abs(dist) < 220) { item.x += dist * 0.05; item.el.style.left = item.x + "px"; }
          }
          item.y += isFever ? speedFall * 1.5 : speedFall;
          item.el.style.top = item.y + "px";
          const iRect = item.el.getBoundingClientRect();
          const pRect = playerEl.getBoundingClientRect();

          if(iRect.bottom > pRect.top + 20 && iRect.top < pRect.bottom - 10 && iRect.left < pRect.right - 20 && iRect.right > pRect.left + 20){
            if(item.type === "bomb") { triggerDamage(); spawnPopup("ðŸ’¥", iRect.left, iRect.top); }
            else if(item.type === "heart") { 
                health = Math.min(3, health+1); 
                updateHealthUI(); 
                playSfx(snd.start); 
                spawnPopup("â¤ï¸", iRect.left, iRect.top); 
            }
            else { 
                score += isFever ? 2 : 1; combo++; document.getElementById("scoreDisp").textContent = score;
                playSfx(snd.pickup); spawnPopup(isFever ? "+2" : "+1", iRect.left, iRect.top);
                if(combo >= 10 && !isFever) startFever();
                speedFall += 0.02;
            }
            item.el.remove(); fallingItems.splice(i,1);
          } 
          else if(item.y > window.innerHeight) {
            if(item.type === "normal" && !isFever) { triggerDamage(); combo = 0; }
            item.el.remove(); fallingItems.splice(i,1);
          }
        }
      }
      requestAnimationFrame(update);
    }

    function spawnPopup(text, x, y) {
      const p = document.createElement("div");
      p.className = "popup";
      p.textContent = text;
      p.style.left = x + "px"; p.style.top = y + "px";
      gameContainer.appendChild(p);
      setTimeout(() => p.remove(), 800);
    }

    function gameOver(){
      isGameOver = true;
      if(snd.game) snd.game.pause();
      document.getElementById("finalScore").textContent="Final Score: " + score;
      slideTo("gameOverPage");
    }
    
    update();
